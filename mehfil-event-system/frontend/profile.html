<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Mehfil</title>
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar" id="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <a href="index.html" class="brand-link">
                    <i class="fas fa-masks"></i>
                    <span class="brand-text">Mehfil</span>
                </a>
            </div>
            
            <div class="nav-menu" id="navMenu">
                <a href="index.html" class="nav-link">Home</a>
                <a href="events.html" class="nav-link">Events</a>
                <a href="about.html" class="nav-link">About</a>
                <a href="contact.html" class="nav-link">Contact</a>
            </div>
            
            <div class="nav-user" id="navUser">
                <div class="user-dropdown">
                    <button class="user-btn" id="userBtn">
                        <img src="assets/images/default-avatar.png" alt="Profile" class="user-avatar" id="userAvatar">
                        <span class="user-name" id="userName">User</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="dropdown-menu" id="dropdownMenu">
                        <a href="dashboard.html" class="dropdown-item">
                            <i class="fas fa-tachometer-alt"></i> Dashboard
                        </a>
                        <a href="profile.html" class="dropdown-item active">
                            <i class="fas fa-user"></i> Profile
                        </a>
                        <div class="dropdown-divider"></div>
                        <button class="dropdown-item logout-btn" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </div>
            
            <button class="nav-toggle" id="navToggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </nav>

    <!-- Profile Container -->
    <div class="profile-container">
        <div class="container">
            <!-- Profile Header -->
            <div class="profile-header">
                <div class="profile-cover">
                    <img src="assets/images/profile-cover.jpg" alt="Cover" id="profileCover">
                    <button class="cover-upload-btn" onclick="uploadCover()">
                        <i class="fas fa-camera"></i>
                    </button>
                </div>
                
                <div class="profile-info">
                    <div class="profile-avatar-section">
                        <div class="profile-avatar">
                            <img src="assets/images/default-avatar.png" alt="Profile" id="profileAvatar">
                            <button class="avatar-upload-btn" onclick="uploadAvatar()">
                                <i class="fas fa-camera"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="profile-details">
                        <h1 id="profileName">User Name</h1>
                        <p class="profile-role" id="profileRole">Role</p>
                        <p class="profile-bio" id="profileBio">Bio will be displayed here</p>
                        
                        <div class="profile-stats">
                            <div class="stat-item">
                                <span class="stat-number" id="profileEventsCount">0</span>
                                <span class="stat-label">Events</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number" id="profileFollowers">0</span>
                                <span class="stat-label">Followers</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number" id="profileRating">0.0</span>
                                <span class="stat-label">Rating</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Content -->
            <div class="profile-content">
                <!-- Profile Tabs -->
                <div class="profile-tabs">
                    <button class="tab-btn active" data-tab="details">Profile Details</button>
                    <button class="tab-btn" data-tab="security">Security</button>
                    <button class="tab-btn" data-tab="preferences">Preferences</button>
                    <button class="tab-btn" data-tab="notifications">Notifications</button>
                    <div class="tab-btn role-specific hidden" data-tab="portfolio">Portfolio</div>
                    <div class="tab-btn role-specific hidden" data-tab="business">Business Info</div>
                </div>

                <!-- Tab Content -->
                <div class="tab-content">
                    <!-- Profile Details Tab -->
                    <div class="tab-pane active" id="detailsTab">
                        <div class="profile-form">
                            <form id="profileForm" onsubmit="updateProfile(event)">
                                <div class="form-section">
                                    <h3>Personal Information</h3>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="firstName">First Name</label>
                                            <input type="text" id="firstName" name="firstName" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="lastName">Last Name</label>
                                            <input type="text" id="lastName" name="lastName" required>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="email">Email Address</label>
                                        <input type="email" id="email" name="email" required>
                                        <small class="form-help">This is your login email</small>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="phone">Phone Number</label>
                                        <input type="tel" id="phone" name="phone" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="dateOfBirth">Date of Birth</label>
                                        <input type="date" id="dateOfBirth" name="dateOfBirth">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="gender">Gender</label>
                                        <select id="gender" name="gender">
                                            <option value="">Select Gender</option>
                                            <option value="male">Male</option>
                                            <option value="female">Female</option>
                                            <option value="other">Other</option>
                                            <option value="prefer-not-to-say">Prefer not to say</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="bio">Bio</label>
                                        <textarea id="bio" name="bio" rows="4" placeholder="Tell us about yourself..."></textarea>
                                    </div>
                                </div>
                                
                                <div class="form-section">
                                    <h3>Location</h3>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="city">City</label>
                                            <select id="city" name="city">
                                                <option value="">Select City</option>
                                                <option value="karachi">Karachi</option>
                                                <option value="lahore">Lahore</option>
                                                <option value="islamabad">Islamabad</option>
                                                <option value="peshawar">Peshawar</option>
                                                <option value="quetta">Quetta</option>
                                                <option value="faisalabad">Faisalabad</option>
                                                <option value="multan">Multan</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="country">Country</label>
                                            <select id="country" name="country">
                                                <option value="pakistan">Pakistan</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="address">Address</label>
                                        <textarea id="address" name="address" rows="2" placeholder="Your address..."></textarea>
                                    </div>
                                </div>
                                
                                <!-- Role-specific sections -->
                                <div class="form-section artist-section hidden">
                                    <h3>Artist Information</h3>
                                    
                                    <div class="form-group">
                                        <label for="specialty">Specialty</label>
                                        <select id="specialty" name="specialty">
                                            <option value="">Select Specialty</option>
                                            <option value="singer">Singer</option>
                                            <option value="dancer">Dancer</option>
                                            <option value="musician">Musician</option>
                                            <option value="actor">Actor</option>
                                            <option value="comedian">Comedian</option>
                                            <option value="poet">Poet</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="experience">Years of Experience</label>
                                        <input type="number" id="experience" name="experience" min="0" max="50">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="skills">Skills</label>
                                        <input type="text" id="skills" name="skills" placeholder="Enter skills separated by commas">
                                        <small class="form-help">e.g., Classical Music, Folk Dance, Stand-up Comedy</small>
                                    </div>
                                </div>
                                
                                <div class="form-section organizer-section hidden">
                                    <h3>Organizer Information</h3>
                                    
                                    <div class="form-group">
                                        <label for="organization">Organization</label>
                                        <input type="text" id="organization" name="organization" placeholder="Company/Organization name">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="website">Website</label>
                                        <input type="url" id="website" name="website" placeholder="https://your-website.com">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="businessType">Business Type</label>
                                        <select id="businessType" name="businessType">
                                            <option value="">Select Business Type</option>
                                            <option value="individual">Individual</option>
                                            <option value="company">Company</option>
                                            <option value="nonprofit">Non-profit</option>
                                            <option value="government">Government</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-actions">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Save Changes
                                    </button>
                                    <button type="button" class="btn btn-outline" onclick="resetForm()">
                                        <i class="fas fa-undo"></i> Reset
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Security Tab -->
                    <div class="tab-pane" id="securityTab">
                        <div class="security-section">
                            <h3>Change Password</h3>
                            <form id="passwordForm" onsubmit="changePassword(event)">
                                <div class="form-group">
                                    <label for="currentPassword">Current Password</label>
                                    <input type="password" id="currentPassword" name="currentPassword" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="newPassword">New Password</label>
                                    <input type="password" id="newPassword" name="newPassword" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="confirmNewPassword">Confirm New Password</label>
                                    <input type="password" id="confirmNewPassword" name="confirmNewPassword" required>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-key"></i> Change Password
                                </button>
                            </form>
                        </div>
                        
                        <div class="security-section">
                            <h3>Two-Factor Authentication</h3>
                            <div class="security-option">
                                <div class="option-info">
                                    <h4>Enable 2FA</h4>
                                    <p>Add an extra layer of security to your account</p>
                                </div>
                                <div class="option-control">
                                    <label class="toggle">
                                        <input type="checkbox" id="enable2FA" onchange="toggle2FA()">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="security-section">
                            <h3>Login Sessions</h3>
                            <div class="sessions-list" id="sessionsList">
                                <div class="session-item current">
                                    <div class="session-info">
                                        <h4>Current Session</h4>
                                        <p>Windows • Chrome • Karachi, Pakistan</p>
                                        <small>Active now</small>
                                    </div>
                                    <span class="session-status">Active</span>
                                </div>
                            </div>
                            <button class="btn btn-outline" onclick="terminateAllSessions()">
                                <i class="fas fa-sign-out-alt"></i> Terminate All Other Sessions
                            </button>
                        </div>
                    </div>

                    <!-- Preferences Tab -->
                    <div class="tab-pane" id="preferencesTab">
                        <div class="preferences-section">
                            <h3>Event Preferences</h3>
                            <form id="preferencesForm" onsubmit="updatePreferences(event)">
                                <div class="form-group">
                                    <label>Preferred Event Categories</label>
                                    <div class="checkbox-group">
                                        <label class="checkbox">
                                            <input type="checkbox" name="categories" value="music">
                                            <span class="checkmark"></span>
                                            Music
                                        </label>
                                        <label class="checkbox">
                                            <input type="checkbox" name="categories" value="dance">
                                            <span class="checkmark"></span>
                                            Dance
                                        </label>
                                        <label class="checkbox">
                                            <input type="checkbox" name="categories" value="theater">
                                            <span class="checkmark"></span>
                                            Theater
                                        </label>
                                        <label class="checkbox">
                                            <input type="checkbox" name="categories" value="art">
                                            <span class="checkmark"></span>
                                            Art
                                        </label>
                                        <label class="checkbox">
                                            <input type="checkbox" name="categories" value="literature">
                                            <span class="checkmark"></span>
                                            Literature
                                        </label>
                                        <label class="checkbox">
                                            <input type="checkbox" name="categories" value="cultural">
                                            <span class="checkmark"></span>
                                            Cultural
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="language">Preferred Language</label>
                                    <select id="language" name="language">
                                        <option value="en">English</option>
                                        <option value="ur">Urdu</option>
                                        <option value="punjabi">Punjabi</option>
                                        <option value="sindhi">Sindhi</option>
                                        <option value="pashto">Pashto</option>
                                        <option value="balochi">Balochi</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="currency">Currency</label>
                                    <select id="currency" name="currency">
                                        <option value="PKR">Pakistani Rupee (PKR)</option>
                                        <option value="USD">US Dollar (USD)</option>
                                        <option value="EUR">Euro (EUR)</option>
                                    </select>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Save Preferences
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Notifications Tab -->
                    <div class="tab-pane" id="notificationsTab">
                        <div class="notifications-section">
                            <h3>Notification Settings</h3>
                            <form id="notificationsForm" onsubmit="updateNotifications(event)">
                                <div class="notification-group">
                                    <h4>Email Notifications</h4>
                                    
                                    <div class="notification-option">
                                        <div class="option-info">
                                            <h5>Event Reminders</h5>
                                            <p>Get reminded about upcoming events you've booked</p>
                                        </div>
                                        <label class="toggle">
                                            <input type="checkbox" name="emailReminders" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                    
                                    <div class="notification-option">
                                        <div class="option-info">
                                            <h5>New Events</h5>
                                            <p>Get notified about new events in your preferred categories</p>
                                        </div>
                                        <label class="toggle">
                                            <input type="checkbox" name="emailNewEvents" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                    
                                    <div class="notification-option">
                                        <div class="option-info">
                                            <h5>Marketing</h5>
                                            <p>Receive promotional emails and special offers</p>
                                        </div>
                                        <label class="toggle">
                                            <input type="checkbox" name="emailMarketing">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="notification-group">
                                    <h4>Push Notifications</h4>
                                    
                                    <div class="notification-option">
                                        <div class="option-info">
                                            <h5>Booking Confirmations</h5>
                                            <p>Get instant notifications when your bookings are confirmed</p>
                                        </div>
                                        <label class="toggle">
                                            <input type="checkbox" name="pushBookings" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                    
                                    <div class="notification-option">
                                        <div class="option-info">
                                            <h5>Event Updates</h5>
                                            <p>Get notified about changes to events you're attending</p>
                                        </div>
                                        <label class="toggle">
                                            <input type="checkbox" name="pushUpdates" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Save Notification Settings
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Upload Modal -->
    <div class="modal hidden" id="imageUploadModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="uploadModalTitle">Upload Image</h3>
                <button class="modal-close" onclick="closeModal('imageUploadModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <p>Drag and drop an image here, or click to select</p>
                    <input type="file" id="imageInput" accept="image/*" style="display: none;">
                    <button class="btn btn-outline" onclick="document.getElementById('imageInput').click()">
                        Select Image
                    </button>
                </div>
                <div class="image-preview hidden" id="imagePreview">
                    <img id="previewImage" src="" alt="Preview">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('imageUploadModal')">Cancel</button>
                <button class="btn btn-primary" id="uploadImageBtn" onclick="confirmImageUpload()">
                    Upload
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay hidden" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <p>Processing...</p>
    </div>

    <!-- Notification -->
    <div class="notification hidden" id="notification">
        <span class="notification-message" id="notificationMessage"></span>
        <button class="notification-close" id="notificationClose">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Scripts -->
    <script src="assets/js/config.js"></script>
    <script src="assets/js/utils.js"></script>
    <script src="assets/js/api.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/main.js"></script>
    
    <script>
        let currentUser = null;
        let currentUploadType = null;

        // Initialize profile page
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            if (!auth.isAuthenticated()) {
                window.location.href = 'auth.html';
                return;
            }

            currentUser = auth.getCurrentUser();
            initializeProfile();
            loadUserProfile();
            setupTabNavigation();
            setupImageUpload();
        });

        function initializeProfile() {
            // Update navigation user info
            document.getElementById('userName').textContent = currentUser.name;
            if (currentUser.avatar) {
                document.getElementById('userAvatar').src = currentUser.avatar;
            }

            // Show role-specific tabs
            if (currentUser.role === 'artist') {
                document.querySelector('[data-tab="portfolio"]').classList.remove('hidden');
            } else if (currentUser.role === 'organizer') {
                document.querySelector('[data-tab="business"]').classList.remove('hidden');
            }
        }

        async function loadUserProfile() {
            try {
                showLoading();
                
                const response = await api.getUserProfile();
                
                if (response.success) {
                    populateProfileData(response.user);
                } else {
                    throw new Error('Failed to load profile');
                }
                
                hideLoading();
            } catch (error) {
                console.error('Error loading profile:', error);
                hideLoading();
                showNotification('Failed to load profile data', 'error');
            }
        }

        function populateProfileData(user) {
            // Header info
            document.getElementById('profileName').textContent = user.name;
            document.getElementById('profileRole').textContent = user.role.charAt(0).toUpperCase() + user.role.slice(1);
            document.getElementById('profileBio').textContent = user.bio || 'No bio provided';
            
            if (user.avatar) {
                document.getElementById('profileAvatar').src = user.avatar;
            }
            
            if (user.coverImage) {
                document.getElementById('profileCover').src = user.coverImage;
            }

            // Stats
            document.getElementById('profileEventsCount').textContent = user.stats?.eventsCount || 0;
            document.getElementById('profileFollowers').textContent = user.stats?.followers || 0;
            document.getElementById('profileRating').textContent = (user.stats?.rating || 0).toFixed(1);

            // Form fields
            document.getElementById('firstName').value = user.firstName || '';
            document.getElementById('lastName').value = user.lastName || '';
            document.getElementById('email').value = user.email || '';
            document.getElementById('phone').value = user.phone || '';
            document.getElementById('dateOfBirth').value = user.dateOfBirth ? user.dateOfBirth.split('T')[0] : '';
            document.getElementById('gender').value = user.gender || '';
            document.getElementById('bio').value = user.bio || '';
            document.getElementById('city').value = user.city || '';
            document.getElementById('country').value = user.country || 'pakistan';
            document.getElementById('address').value = user.address || '';

            // Role-specific fields
            if (user.role === 'artist') {
                document.querySelector('.artist-section').classList.remove('hidden');
                document.getElementById('specialty').value = user.specialty || '';
                document.getElementById('experience').value = user.experience || '';
                document.getElementById('skills').value = user.skills ? user.skills.join(', ') : '';
            } else if (user.role === 'organizer') {
                document.querySelector('.organizer-section').classList.remove('hidden');
                document.getElementById('organization').value = user.organization || '';
                document.getElementById('website').value = user.website || '';
                document.getElementById('businessType').value = user.businessType || '';
            }

            // Preferences
            if (user.preferences) {
                document.getElementById('language').value = user.preferences.language || 'en';
                document.getElementById('currency').value = user.preferences.currency || 'PKR';
                
                if (user.preferences.categories) {
                    user.preferences.categories.forEach(category => {
                        const checkbox = document.querySelector(`[name="categories"][value="${category}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
            }

            // Notification settings
            if (user.notifications) {
                Object.keys(user.notifications).forEach(key => {
                    const checkbox = document.querySelector(`[name="${key}"]`);
                    if (checkbox) checkbox.checked = user.notifications[key];
                });
            }
        }

        function setupTabNavigation() {
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabPanes = document.querySelectorAll('.tab-pane');

            tabBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const targetTab = this.dataset.tab;
                    
                    // Update active tab button
                    tabBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Update active tab pane
                    tabPanes.forEach(pane => pane.classList.remove('active'));
                    document.getElementById(targetTab + 'Tab').classList.add('active');
                });
            });
        }

        function setupImageUpload() {
            const imageInput = document.getElementById('imageInput');
            const uploadArea = document.getElementById('uploadArea');
            const imagePreview = document.getElementById('imagePreview');
            const previewImage = document.getElementById('previewImage');

            imageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewImage.src = e.target.result;
                        uploadArea.classList.add('hidden');
                        imagePreview.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Drag and drop functionality
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('drag-over');
            });

            uploadArea.addEventListener('dragleave', function() {
                this.classList.remove('drag-over');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    imageInput.files = files;
                    imageInput.dispatchEvent(new Event('change'));
                }
            });
        }

        async function updateProfile(event) {
            event.preventDefault();
            
            try {
                showLoading();
                
                const formData = new FormData(event.target);
                const profileData = {};
                
                // Basic fields
                profileData.firstName = formData.get('firstName');
                profileData.lastName = formData.get('lastName');
                profileData.email = formData.get('email');
                profileData.phone = formData.get('phone');
                profileData.dateOfBirth = formData.get('dateOfBirth');
                profileData.gender = formData.get('gender');
                profileData.bio = formData.get('bio');
                profileData.city = formData.get('city');
                profileData.country = formData.get('country');
                profileData.address = formData.get('address');

                // Role-specific fields
                if (currentUser.role === 'artist') {
                    profileData.specialty = formData.get('specialty');
                    profileData.experience = formData.get('experience');
                    profileData.skills = formData.get('skills')?.split(',').map(s => s.trim()).filter(s => s);
                } else if (currentUser.role === 'organizer') {
                    profileData.organization = formData.get('organization');
                    profileData.website = formData.get('website');
                    profileData.businessType = formData.get('businessType');
                }

                // Remove empty fields
                Object.keys(profileData).forEach(key => {
                    if (!profileData[key]) {
                        delete profileData[key];
                    }
                });

                const response = await api.updateUserProfile(profileData);
                
                if (response.success) {
                    // Update current user data
                    auth.updateCurrentUser(response.user);
                    currentUser = response.user;
                    
                    showNotification('Profile updated successfully!', 'success');
                } else {
                    throw new Error(response.message || 'Failed to update profile');
                }
                
                hideLoading();
            } catch (error) {
                console.error('Error updating profile:', error);
                hideLoading();
                showNotification(error.message || 'Failed to update profile', 'error');
            }
        }

        async function changePassword(event) {
            event.preventDefault();
            
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmNewPassword').value;
            
            if (newPassword !== confirmPassword) {
                showNotification('New passwords do not match', 'error');
                return;
            }
            
            try {
                showLoading();
                
                const passwordData = {
                    currentPassword: document.getElementById('currentPassword').value,
                    newPassword: newPassword
                };
                
                const response = await api.changePassword(passwordData);
                
                if (response.success) {
                    document.getElementById('passwordForm').reset();
                    showNotification('Password changed successfully!', 'success');
                } else {
                    throw new Error(response.message || 'Failed to change password');
                }
                
                hideLoading();
            } catch (error) {
                console.error('Error changing password:', error);
                hideLoading();
                showNotification(error.message || 'Failed to change password', 'error');
            }
        }

        async function updatePreferences(event) {
            event.preventDefault();
            
            try {
                showLoading();
                
                const formData = new FormData(event.target);
                const categories = [];
                
                formData.getAll('categories').forEach(category => {
                    categories.push(category);
                });
                
                const preferences = {
                    categories: categories,
                    language: formData.get('language'),
                    currency: formData.get('currency')
                };
                
                const response = await api.updateUserPreferences(preferences);
                
                if (response.success) {
                    showNotification('Preferences updated successfully!', 'success');
                } else {
                    throw new Error(response.message || 'Failed to update preferences');
                }
                
                hideLoading();
            } catch (error) {
                console.error('Error updating preferences:', error);
                hideLoading();
                showNotification(error.message || 'Failed to update preferences', 'error');
            }
        }

        async function updateNotifications(event) {
            event.preventDefault();
            
            try {
                showLoading();
                
                const formData = new FormData(event.target);
                const notifications = {
                    emailReminders: formData.has('emailReminders'),
                    emailNewEvents: formData.has('emailNewEvents'),
                    emailMarketing: formData.has('emailMarketing'),
                    pushBookings: formData.has('pushBookings'),
                    pushUpdates: formData.has('pushUpdates')
                };
                
                const response = await api.updateNotificationSettings(notifications);
                
                if (response.success) {
                    showNotification('Notification settings updated successfully!', 'success');
                } else {
                    throw new Error(response.message || 'Failed to update notifications');
                }
                
                hideLoading();
            } catch (error) {
                console.error('Error updating notifications:', error);
                hideLoading();
                showNotification(error.message || 'Failed to update notifications', 'error');
            }
        }

        function uploadAvatar() {
            currentUploadType = 'avatar';
            document.getElementById('uploadModalTitle').textContent = 'Upload Profile Picture';
            showModal('imageUploadModal');
        }

        function uploadCover() {
            currentUploadType = 'cover';
            document.getElementById('uploadModalTitle').textContent = 'Upload Cover Photo';
            showModal('imageUploadModal');
        }

        async function confirmImageUpload() {
            const imageInput = document.getElementById('imageInput');
            const file = imageInput.files[0];
            
            if (!file) {
                showNotification('Please select an image', 'error');
                return;
            }
            
            try {
                showLoading();
                closeModal('imageUploadModal');
                
                const formData = new FormData();
                formData.append('image', file);
                formData.append('type', currentUploadType);
                
                const response = await api.uploadProfileImage(formData);
                
                if (response.success) {
                    // Update image on page
                    if (currentUploadType === 'avatar') {
                        document.getElementById('profileAvatar').src = response.imageUrl;
                        document.getElementById('userAvatar').src = response.imageUrl;
                    } else {
                        document.getElementById('profileCover').src = response.imageUrl;
                    }
                    
                    showNotification('Image uploaded successfully!', 'success');
                } else {
                    throw new Error(response.message || 'Failed to upload image');
                }
                
                hideLoading();
            } catch (error) {
                console.error('Error uploading image:', error);
                hideLoading();
                showNotification(error.message || 'Failed to upload image', 'error');
            }
        }

        function resetForm() {
            if (confirm('Are you sure you want to reset all changes?')) {
                loadUserProfile();
            }
        }

        function toggle2FA() {
            const enabled = document.getElementById('enable2FA').checked;
            if (enabled) {
                showNotification('2FA setup will be implemented soon', 'info');
                document.getElementById('enable2FA').checked = false;
            }
        }

        function terminateAllSessions() {
            if (confirm('This will log you out from all other devices. Continue?')) {
                showNotification('All sessions terminated', 'success');
            }
        }
    </script>
</body>
</html>
